
version: 2.1

# Define the jobs we want to run for this project
jobs:
  build-bears-app:
    machine:
      image: ubuntu-2004:202107-02
    steps:
      - run:
          name: Cloning the Repo and initiating the Submodule
          command: |
            echo "cloning the repo and initiating the usagov-2021 submodule"
            git clone -b "$CIRCLE_BRANCH" "$CIRCLE_REPOSITORY_URL"
            cd px-bears-drupal
            git submodule init
            git submodule update

      - run:
          name: Moving the bears app into usagov-2021 module
          command: |
            cd px-bears-drupal
            bash ./mv-bears-app.sh
            echo ".................."
            echo "moving the bears-app module into the usagov-2021 directory"
            mv  usagov_bears usagov-2021/web/modules/custom
            ls -l usagov-2021/web/modules/custom/

      - run: 
          name: Pre-docker-build configurations
          command: |
            cd px-bears-drupal
            mv usagov-2021/.docker/Dockerfile-cms .
            sed -i 's/80/8080/g' Dockerfile-cms  
            sed -i 's/80/8080/g' usagov-2021/.docker/src-cms/etc/nginx/partials/cms.conf.tmpl
            sed -i 's/80/8080/g' usagov-2021/.docker/src-cms/etc/nginx/partials/www.conf.tmpl

      - run: 
          name: Building  and tagging the Docker Image
          command: |
            export IMAGE_TAG=$( echo $CIRCLE_WORKFLOW_ID | cut -b -8 )
            export DOCKER_REPO="fbakir/bears-cms"
            cd px-bears-drupal
            ls -l
            docker build -f ./Dockerfile-cms -t $DOCKER_REPO:$IMAGE_TAG .
            docker images


            



      

# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - build-bears-app


            
          